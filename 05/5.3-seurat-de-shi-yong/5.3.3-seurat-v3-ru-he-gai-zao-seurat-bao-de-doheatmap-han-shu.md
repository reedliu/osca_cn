---
description: åˆ˜å°æ³½å†™äº19.12.4
---

# 5.3.2 Seurat V3 \| å¦‚ä½•æ”¹é€ SeuratåŒ…çš„DoHeatmapå‡½æ•°ï¼Ÿ

> åˆ†æè¿‡å•ç»†èƒæ•°æ®çš„å°ä¼™ä¼´åº”è¯¥éƒ½ä½¿ç”¨è¿‡SeuratåŒ…ï¼Œå…¶ä¸­æœ‰ä¸ªå‡½æ•°å«`DoHeatmap`ï¼Œå…·ä½“æ“ä½œå¯ä»¥çœ‹ï¼š [å•ç»†èƒè½¬å½•ç»„å­¦ä¹ ç¬”è®°-17-ç”¨SeuratåŒ…åˆ†ææ–‡ç« æ•°æ®](https://www.jianshu.com/p/f6f54ce92e24)

## å‰è¨€

èµ°å®ŒSeuratæµç¨‹ï¼Œä¼šå¾—åˆ°åˆ†ç¾¤ç»“æœ`FindClusters()`ï¼Œå¹¶æ‰¾åˆ°markeråŸºå› `FindAllMarkers()`ï¼Œç„¶åæƒ³è¦å¯¹æ¯ç¾¤çš„å‰10ä¸ªmarkeråŸºå› è¿›è¡Œçƒ­å›¾å¯è§†åŒ–

```r
rm(list = ls()) 
options(warn=-1) 
options(stringsAsFactors = F)

install.packages('Seurat')
library(Seurat)
library(stringr)   
library(dplyr)  

load('sce_out_for_heatmap_all.Rdata')
top10 <- sce.markers %>% group_by(cluster) %>% top_n(10, avg_logFC)
DoHeatmap(sce,top10$gene,size=3)
```

![plot\_zoom\_png](https://jieandze1314-1255603621.cos.ap-guangzhou.myqcloud.com/blog/2019-12-04-071009.png)

ä½†æ˜¯è¿™ä¸ªå›¾åœ¨åæœŸè°ƒæ•´æ—¶ä¼šé‡åˆ°å¾ˆå¤šéšœç¢ï¼Œå› æ­¤æœ€å¥½ç”¨pheatmapé‡æ–°ç”»ä¸€ä¸‹

## å¦‚ä½•ç”¨Pheatmapç”»è¿™ä¸ªç»“æœï¼Ÿ

å…¶å®ï¼Œ**ç”»ä¸€ä¸ªçƒ­å›¾æœ€é‡è¦çš„æ˜¯è¡¨è¾¾çŸ©é˜µå’Œåˆ†ç»„ä¿¡æ¯**

### **ç¬¬1æ­¥ï¼šå¾—åˆ°è¡¨è¾¾çŸ©é˜µ**

é‚£ä¹ˆç°åœ¨æœ‰äº†sceå¯¹è±¡ï¼Œä»ä¸­æå–è¡¨è¾¾çŸ©é˜µä¹Ÿä¸éš¾

```r
# æå–åŸå§‹è¡¨è¾¾çŸ©é˜µ
cts <- GetAssayData(sce, slot = "counts")
> cts[1:4,1:4]
4 x 4 sparse Matrix of class "dgCMatrix"
               A1_01 A1_10 A1_11 A1_12
00R-AC107638.2      .      2      .      2
0610005C13Rik       .      .      .      .
0610007P14Rik       1     49      3    328
0610009B22Rik       .     12      .     78
# ç„¶åå¯¹è¿™ä¸ªçŸ©é˜µå–log
cts <- log10(cts + 1)
```

### **ç¬¬2æ­¥ï¼šå¾—åˆ°å°çš„top10è¡¨è¾¾çŸ©é˜µ**

å½“ç„¶ä¸èƒ½ä½¿ç”¨æ•´ä¸ªè¡¨è¾¾çŸ©é˜µè¿›è¡Œå¤„ç†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Seuratå¾—åˆ°çš„`top10`ç»“æœï¼Œå®ƒå¸®æˆ‘ä»¬å¾—åˆ°äº†æ¯ä¸ªclusterçš„markeråŸºå› ï¼Œè€Œæˆ‘ä»¬**åªéœ€è¦å–å‡ºè¿™ä¸ªå°è¡¨è¾¾çŸ©é˜µå³å¯**

Seuratå¾—åˆ°çš„top10è®¡ç®—ç»“æœæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆ**çŸ©é˜µçš„è¡Œå°±æŒ‰åŸºå› åå–ï¼š**

![](https://jieandze1314-1255603621.cos.ap-guangzhou.myqcloud.com/blog/2019-12-04-072247.png)

å› ä¸ºè¿™ä¸ªçƒ­å›¾ç»“æœæ˜¯æŒ‰ç…§clusterè¿›è¡Œæ’åºå±•ç¤ºçš„ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿè¦**å°†å°è¡¨è¾¾çŸ©é˜µçš„åˆ—æŒ‰clusterä»å°åˆ°å¤§æ’åºï¼š**

```r
# åŸæ¥çš„clusteråˆ†ç»„ä¿¡æ¯å­˜å‚¨åœ¨ sce$seurat_clusters ä¸­
> head(sce$seurat_clusters)
A1_01 A1_10 A1_11 A1_12 A1_13 A1_14 
     4      4      4      4      4      4 
Levels: 0 1 2 3 4 5 6 7 8
# å¯è§å¹¶ä¸æ˜¯ä»ç¬¬0ä¸ªclusterå¼€å§‹çš„

# æ’åºä¹‹å
new_cluster <- sort(sce$seurat_clusters)
> head(new_cluster)
A10_09 A10_16 A10_18 A10_33 A10_36 A10_42 
      0       0       0       0       0       0 
Levels: 0 1 2 3 4 5 6 7 8
```

ğŸ‘Œæœ‰äº†è¡Œå’Œåˆ—çš„è§„å®šï¼Œæˆ‘ä»¬å°±èƒ½å¾ˆè½»æ¾åœ°æå–å‡ºæ•´ä¸ªå°çš„è¡¨è¾¾çŸ©é˜µï¼š

```r
cts <- as.matrix(cts[top10$gene, names(new_cluster)])
```

### **ç¬¬3æ­¥ï¼šåšä¸€ä¸ªåˆ—çš„æ³¨é‡Š**

å› ä¸ºè¦åšå‡ºæ¥DoHeatmapçš„é¡¶éƒ¨0-8 clusterçš„å±•ç¤ºï¼Œéœ€è¦ä½¿ç”¨pheatmapçš„ä¸€ä¸ªå‚æ•°ï¼š`annotation_col`

è¿™ä¸ªå‚æ•°æ¥æ”¶ä¸€ä¸ªæ•°æ®æ¡†ä½œä¸ºè¾“å…¥ã€‚å› ä¸ºæ˜¯å¯¹åˆ—è¿›è¡Œæ³¨é‡Šï¼Œæ‰€ä»¥è¿™ä¸ªæ•°æ®æ¡†çš„è¡Œæ˜¯çŸ©é˜µçš„åˆ—åï¼Œè€Œå®ƒçš„åˆ—åœ¨è¿™é‡Œå¯¹åº”çš„å°±æ˜¯clusteråˆ†ç¾¤ä¿¡æ¯

```r
ac=data.frame(cluster=new_cluster)
rownames(ac)=colnames(mat)
> head(ac)
        cluster
A10_09       0
A10_16       0
A10_18       0
A10_33       0
A10_36       0
A10_42       0
```

æœ€åï¼Œå°±å¯ä»¥ç”»å›¾äº†ï¼š

```r
library(pheatmap)
pheatmap(cts,show_colnames =F,show_rownames = T,
         cluster_rows = F,
         cluster_cols = F,
         annotation_col=ac)
```

![plot\_zoom\_png-2](https://jieandze1314-1255603621.cos.ap-guangzhou.myqcloud.com/blog/2019-12-04-073859.png)

å½“ç„¶ï¼Œè¿™ä¸ªpheatmapæœ‰å¾ˆå¤šå‚æ•°å¯ä»¥è°ƒæ•´ï¼Œçœ‹å®ƒçš„å‚æ•°å°±çŸ¥é“ï¼š

æ¯”å¦‚æƒ³åŠ ä¸Šæ¯ä¸ªclusterçš„åˆ†éš”ï¼Œéœ€è¦ç”¨åˆ°å‚æ•°`gaps_col =` ï¼Œä¸è¿‡éœ€è¦æä¾›æ¯ä¸ªclusteræœ€åä¸€ä¸ªç»†èƒçš„åºå·

ã€å½“ç„¶è¿™ä¸ªæ˜¯åè¯äº†ï¼Œæœ€é‡è¦çš„æ˜¯çŸ¥é“å¦‚ä½•è¿›è¡Œæ•°æ®çš„è½¬æ¢ã€‘

![](https://jieandze1314-1255603621.cos.ap-guangzhou.myqcloud.com/blog/2019-12-04-073958.png)

### é™¤äº†pheatmapï¼Œå½“ç„¶è¿˜èƒ½ç”¨å…¶ä»–çš„åŒ…

ç”»çƒ­å›¾çš„åŒ…æœ‰å¾ˆå¤šï¼Œå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å°±æ˜¯`ComplexHeatmap`

ä¾‹å¦‚ï¼š

```r
BiocManager::install("ComplexHeatmap")
library(ComplexHeatmap)

# åˆ—æ ‡é¢˜çš„é¢œè‰²æ¡†
color <- rainbow(9)
names(color) <- levels(new_cluster)
top_color <- HeatmapAnnotation(
  cluster = anno_block(gp = gpar(fill = color), 
                       labels = levels(new_cluster), 
                       labels_gp = gpar(cex = 0.5, col = "white"))) 

Heatmap(mat,
        cluster_rows = FALSE,
        cluster_columns = FALSE,
        show_column_names = FALSE,
        show_row_names = TRUE,
        column_split = new_cluster,
        heatmap_legend_param = list(
          title = "log10(count+1)",
          title_position = "leftcenter-rot"
        ),
        top_annotation = top_anno,
        column_title = NULL)
```

ä¹Ÿå¯ä»¥å®ç°åˆ—çš„æ³¨é‡Šï¼Œå¹¶ä¸”å°†æ¯ä¸ªclusterçš„åˆ—éƒ½è¿›è¡Œåˆ†éš”ï¼Œå’Œ`DoHeatmap`çš„ç»“æœæ›´åƒ

![plot\_zoom\_png-3](https://jieandze1314-1255603621.cos.ap-guangzhou.myqcloud.com/blog/2019-12-04-075333.png)

